<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <title>Project 4</title>
  </head>

  <body class="pageContents">
    <h1>Project 4 - IMAGE WARPING and MOSAICING</h1>
    <div class="wrapper">
      <h2 class="title">Background of the project:</h2>
      <p class="introduction">
        In this project, we are asked to take the pictures that we like
        ourselves, and then warp one of the image into the other using the
        Homography computed by the chosen correspondeing points. And then
        blend/stitch the image together to get a mosaic of the images.
      </p>
      <h3>Part 1. Take the picture you like</h3>
      <p class="description">
        This seems like an easy task, but this task is really the root of having
        a good results. There are several things that you need to be careful
        when taking the picture:
      </p>
      <ol>
        <li>
          When you take the pictures, you need to make sure that all the
          pictures that you take have the same center of projection (COP). So
          when you take the pictures, you need to rotate your camera base on the
          axis of where the camera located. Not where you are standing, not the
          middle of the phone.
        </li>
        <li>
          The pictures that you take should have 40% ~ 70% of overlap between
          each consecutive picture for enough correspondency and easier
          registration
        </li>
        <li>
          It is best to take pictures of stationary scene, if you want to take
          picture of something moving in the scene, try to take each consecutive
          picture as fast as you cn to minimize the movement in each picture.
          One exception is that you want the effects for artistic reason.
        </li>
      </ol>
      <p class="imgTitle">Some Examples:</p>
      <div class="imageWrapper">
        <img src="images/cory529(2).jpg" class="resultImage" />
        <img src="images/cory529(3).jpg" class="resultImage" />
      </div>
      <div class="imageWrapper">
        <img src="images/bedroom1.jpg" class="resultImage" />
        <img src="images/bedroom2.jpg" class="resultImage" />
      </div>
      <div class="imageWrapper">
        <img src="images/kitchen1.jpg" class="resultImage" />
        <img src="images/kitchen2.jpg" class="resultImage" />
      </div>
      <hr />
      <h3>Part 2. Defining Correspondences</h3>
      <p class="description">
        Just like what we did in project 3. In order for the warping to work, we
        need consistent labeling point on both images. Which we need to define
        the correspondence manually on different items and elements in the
        images
        <br /><br />
        In this case, I tried to use barebone
        <a
          href=" https://www.geeksforgeeks.org/matplotlib-pyplot-ginput-in-python/"
          >ginput()</a
        >
        funtion at first, which works fine and it only required several lines of
        code. The problem is, you will need to redo the whole choosing process
        if you make mistakes in the middle. And you also need to write extra
        code to save the correspondeing points into a json file for future use.
        So I instead just used
        <a href="https://cal-cs180.github.io/fa23/hw/proj3/tool.html">this</a>
        labeling tool that is provided in the project 3 assignment specs for
        labeling the correspondence. And it provide the feature that allow the
        users to delete any points they chose during the choosing process, which
        is really convenient. It automatically save the correspondeing points
        into a json file as well.
      </p>

      <p>
        <b class="note">Note:</b> For the next part, you need to choose at least
        4 points to compute the Homography. And if you are taking your picture
        using iphone, which I did. I will suggest you should shrink the image
        for choosing points and for later warping and blending as well. This is
        because the original picture taken by iphone is too big, it will then
        cause your warping and blending a lot of time.
      </p>
      <p>
        <b class="suggestion">Suggestion:</b> Generally. more correspondency is
        better. But if you have some good pictures for easy registration and
        correspondency, you can still get a good results with less points (at
        least 4!)
      </p>

      <p class="imgTitle">Corresponding Points Examples:</p>
      <div class="imageWrapper">
        <img
          src="images/resized with scatter points cory529(2).jpg"
          class="resultImage"
        />
        <img
          src="images/resized with scatter points cory529(3).jpg"
          class="resultImage"
        />
      </div>
      <hr />
      <h3>Part 3. Compute Homography</h3>
      <p class="description">
        How can we warp one image into alignment of the other image? Which we
        will need to compute the Homoraphy between 2 images' correspondency that
        we chose in the previous part. Where H (Homography) is a 3 by 3 matrix
        with 8 degree of freedom (last element is scale). Here are the hand
        written notes of mine about how to compute the Homogeaphy base on the
        correspondency points:
      </p>

      <p class="imgTitle">Homogeaphy details:</p>
      <div class="noteImageWrapper">
        <img src="images/Homography note1.jpeg" class="noteImage" />
        <img src="images/Homography note2.jpeg" class="noteImage" />
        <img src="images/Homography note3.jpeg" class="noteImage" />
      </div>
      <p class="description">
        After you have the above equations setup, you can solve the matrix
        easily by using least square solution
      </p>
      <p>
        <b class="note">Note:</b> We can now see why we need at least 4
        correspondencies to solve a homograhpy. And the above equations are only
        for 1 correspondency. For more Correspondencies, just stack more left
        most matrix with different x1, x2, y1, y2 vertically.
      </p>
      <p>
        <b class="suggestion">Suggestion:</b> For sanity check, you can call one
        of the functions that is prohibited (ex. cv2.findHomography) as stated
        in project spec to see whether the H you computed is correct or not. It
        is normal that the results you have will be a little different than the
        one you get from the function. But don't worry about it if it is really
        small.
      </p>
      <hr />
      <h3>Part 4. Warp Image</h3>
      <p class="description">
        Now we know how to compute the Homography, we can use the Homography
        that we computed to warp an image to the reference image. Here are my
        hand written notes about how to wap image:
      </p>
      <p class="imgTitle" id="warpingNotes">warping details:</p>
      <div class="noteImageWrapper">
        <img
          src="images/warping note1.jpeg"
          class="noteImage"
          id="warpingNote1"
        />
        <img
          src="images/warping note2.jpeg"
          class="noteImage"
          id="warpingNote2"
        />
        <img
          src="images/warping note3.jpeg"
          class="noteImage"
          id="warpingNote3"
        />
      </div>

      <p>
        <b class="note">Note:</b> In the warping function, whenever you apply
        homography or inverse homograhpy, you need to devide the warped
        coordinates by the corresponding scale w (which is the w shown in the
        above homograhpy section).
      </p>
      <p>
        <b class="suggestion">Suggestion:</b> Just like the homography, you can
        call something like cv2.warpPerspective for sanity check. Which the
        result may be different because the function may cut off the image if
        there are negative coordinates after warping. But the function I
        implement shows the whole warped image
      </p>
      <hr />
      <h3>Part 5. Image Retification</h3>
      <p class="description">
        Here comes the part where you can test whether your code for homograhpy
        and warping are correct or not (if you didn't use the sanity check).
        What we need to do here is bascially take a picture with some rectangle
        objects in the scene and define a rectangle area by yourself so that you
        can compute the homography base on the points you choose around the
        rectnagle objects in the scenes and the rectangle area you define
        yourself (I used [[0, 0], [200, 0], [200, 200], [0, 200]] here myself).
      </p>
      <p class="imgTitle">My result:</p>
      <div class="imageWrapper">
        <div class="title-image-wrapper">
          <p class="imagSubTitle">Original Image:</p>
          <img src="images/ipad.jpg" class="resultImage" />
        </div>
        <div class="title-image-wrapper">
          <p class="imagSubTitle">Rectified Image:</p>
          <img src="images/rectified ipad.jpg" class="resultImage" />
        </div>
      </div>
      <div class="imageWrapper">
        <div class="title-image-wrapper">
          <p class="imagSubTitle">Original Image:</p>
          <img src="images/kurumi2.jpg" class="resultImage" />
        </div>
        <div class="title-image-wrapper">
          <p class="imagSubTitle">Rectified Image:</p>
          <img src="images/rectified kurumi.jpg" class="resultImage" />
        </div>
      </div>
      <p class="description">
        You can now observe that, the result image is just like looking right
        into the object instead of from the side in the original image.
      </p>
      <p>
        <b class="note">Note:</b>
        If your result image is not stable or not good enough, you can try to
        choose more points on the rectangle instead of just using the 4 corners
        like I did. And if your original image is taken from a really off angle,
        your result image will look good only in a small portion of the image,
        all other parts will look really stretched. You can crop the image for
        only the good part for the result.
      </p>
      <p>
        <b class="suggestion">Suggestion:</b> if you know your original
        rectangle object's shape (height, width proportion), you can also define
        your rectangle into the same proportion for a better result (like
        instead of using a 200 * 200 square, I should probably use some other
        rectangle shape if I kow the exact proportion since ipad is not a
        square, but this is not requied).
      </p>
      <hr />
      <h3>Part 5. Blend the images into a mosaic</h3>
      <p class="description">
        After you got your rectification working, which means your codes for
        homograhpy and warping are working as well. We can now get into the main
        idea of this ptoject (project 4a), which is image mosaic. The idea is
        really easy, you first warp one image to the reference image. and blend
        the warped image and the reference image into a big mosaic. The idea of
        warping image is the same as image retification, but instead of using a
        rectangle that you define yourself, you use the correspondency points to
        compute homography. And for the blending part, I just use my code from
        project 2 and tweak it a little to blend the image using the mask I
        create.
      </p>
      <p class="imgTitle">My result:</p>
      <div class="imageWrapper">
        <div class="title-image-wrapper">
          <p class="imagSubTitle">Original Image 1:</p>
          <img src="images/cory529(2).jpg" class="resultImage" />
        </div>
        <div class="title-image-wrapper">
          <p class="imagSubTitle">Original Image 2:</p>
          <img src="images/cory529(3).jpg" class="resultImage" />
        </div>
      </div>
      <div class="imageWrapper">
        <div class="title-image-wrapper">
          <p class="imagSubTitle">Blended Image:</p>
          <img src="images/Blend of cory529.jpg" class="resultImage" />
        </div>
      </div>
      <div class="imageWrapper">
        <div class="title-image-wrapper">
          <p class="imagSubTitle">Original Image 1:</p>
          <img src="images/bedroom1.jpg" class="resultImage" />
        </div>
        <div class="title-image-wrapper">
          <p class="imagSubTitle">Original Image 2:</p>
          <img src="images/bedroom2.jpg" class="resultImage" />
        </div>
      </div>
      <div class="imageWrapper">
        <div class="title-image-wrapper">
          <p class="imagSubTitle">Blended Image:</p>
          <img src="images/Blend of bedroom.jpg" class="resultImage" />
        </div>
      </div>
      <div class="imageWrapper">
        <div class="title-image-wrapper">
          <p class="imagSubTitle">Original Image 1:</p>
          <img src="images/kitchen1.jpg" class="resultImage" />
        </div>
        <div class="title-image-wrapper">
          <p class="imagSubTitle">Original Image 2:</p>
          <img src="images/kitchen2.jpg" class="resultImage" />
        </div>
      </div>
      <div class="imageWrapper">
        <div class="title-image-wrapper">
          <p class="imagSubTitle">Blended Image:</p>
          <img src="images/Blend of kitchen.jpg" class="resultImage" />
        </div>
      </div>
      <p>
        <b class="note">Note:</b>
        Since when we warp one image to the reference image, there are some
        translation happening (like mentioned in the above section). We need to
        keep track of that translation and apply that to the reference image as
        well when perform blending.
      </p>
      <p>
        <b class="suggestion">Suggestion:</b> Although alpha blending (channel)
        is also mentioned in the project spec, I think Laplacian pyramid
        blending generally performs better for blending and easier to implement
        since you have went through that already in project 2. You probably just
        need a little modification in the code.
      </p>
      <h4>Some general Q & A about Blending</h4>
      <p>
        <b class="note">Q:</b>
        How do you define the overall output size for the mosaic?
      </p>
      <p>
        <b class="suggestion">A:</b>
        Which is a really similar idea as how you determine the
        <a href="#warpingNotes">ouput size for a warped image</a>. But in this
        case, instead of considering only 4 warped points (corners) of the
        warped image, you need to consider the translation and the 4 points
        (corners) of the reference image as well. Here are some example
        pictures:
      </p>
      <p class="imgTitle">
        Example points you need to consider for the ouput mosaic size:
      </p>
      <div class="imageWrapper">
        <img src="images/output_size example 1.jpg" class="resultImage" />
        <img src="images/output_size example 2.jpg" class="resultImage" />
      </div>
      <p class="description">
        Just like image warping, you now find the min_x, min_y, max_x, max_y
        using all the points and define the output mosaic size.
      </p>
      <p>
        <b class="note">Q:</b>
        How do you create the irregular mask for blending?
      </p>
      <p>
        <b class="suggestion">A:</b>
        For this task, I am using a really naive idea suggested by a TA. Which
        probably only work for vertical and horizontal blending, but is
        sufficient for this task. I first find the mid point of x coordinate (or
        y coordinate if you are doing a vertical blending) of the overlap part
        of the 2 images, and then create a mask base on the coordinate, here are
        some example pictures:
      </p>
      <p class="imgTitle">Example images for creating the irregular mask:</p>
      <div class="imageWrapper">
        <img src="images/mask example 2.jpg" class="resultImage" />
        <img src="images/mask example 1.jpg" class="resultImage" />
      </div>
      <p class="description">
        As you can see, the cutoff of the mask is not exactly in the middle, but
        it is at the middle of the overlap part. And the idea of calculating the
        x coordinate of the mask cutoff is really easy as well. Just use the 4
        points in the middle overlap part, which are the 4 middle blue points
        shown in the previous question. (I only used 2 points since the x
        coordinate of an image on the same side should be really close). And you
        can implement the same idea if you are doing vertical blending, but you
        now need to create the mask base on y coordinate cutoff. After I get the
        mask, I just throw the 2 images and the mask into my Laplacian blending
        code from project 2.
      </p>
      <p>
        <b class="note">Warning:</b>
        As I mentioned above, and you can porbably tell by now, this method only
        works for easy blending task like vertical and horizontal blending. If
        you want a more robust way of creating a mask, you can consider using
        the bwdist() (distance transform) method mentioned in lecture for
        creating mask.
      </p>
      <hr />
      <h3>Final reflection on project 4a</h3>
      <p class="description">
        I really enjoy the time of doing this project because extended reality
        is the area that I interested in for a long time already, and I think
        this project introduce a little basic of the technology and theory to
        us. I really hope I can have more time for 360 Cylindrical panorama B&W,
        which I think will be really interesting and even more like extended
        reality environment. But unfortunately I have no time because of the
        midterms. But I will try to implement that during my own time.
      </p>
    </div>
  </body>
</html>
